"use strict";var qz=function(){function e(e,o){this.setPrinter=function(e){"string"==typeof e&&(e={name:e}),this.printer=e},this.getPrinter=function(){return this.printer},this.reconfigure=function(e){t.tools.extend(this.config,e)},this.getOptions=function(){return this.config},this.setPrinter(e),this.config=o}Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)});var t={VERSION:"2.0.5",DEBUG:!1,log:{trace:function(){t.DEBUG&&console.log.apply(console,arguments)},info:function(){console.info.apply(console,arguments)},warn:function(){t.DEBUG&&console.warn.apply(console,arguments)},error:function(){console.error.apply(console,arguments)}},streams:{serial:"SERIAL",usb:"USB",hid:"HID"},websocket:{connection:null,connectConfig:{host:["localhost","localhost.qz.io"],hostIndex:0,usingSecure:!0,protocol:{secure:"wss://",insecure:"ws://"},port:{secure:[8181,8282,8383,8484],insecure:[8182,8283,8384,8485],portIndex:0},keepAlive:60,retries:0,delay:0},setup:{findConnection:function(e,o,n){if(e.port.secure.length)e.port.insecure.length||e.usingSecure||(t.log.trace("No insecure ports specified - forcing secure connection"),e.usingSecure=!0);else{if(!e.port.insecure.length)return void n(new Error("No ports have been specified to connect over"));e.usingSecure&&(t.log.error("No secure ports specified - forcing insecure connection"),e.usingSecure=!1)}var r,s=function(){if(e.port.portIndex++,e.usingSecure&&e.port.portIndex>=e.port.secure.length||!e.usingSecure&&e.port.portIndex>=e.port.insecure.length){if(e.hostIndex>=e.host.length-1)return void n(new Error("Unable to establish connection with QZ"));e.hostIndex++,e.port.portIndex=0}t.websocket.setup.findConnection(e,o,n)};r=e.usingSecure?e.protocol.secure+e.host[e.hostIndex]+":"+e.port.secure[e.port.portIndex]:e.protocol.insecure+e.host[e.hostIndex]+":"+e.port.insecure[e.port.portIndex];try{t.log.trace("Attempting connection",r),t.websocket.connection=new t.tools.ws(r)}catch(e){return t.log.error(e),void s()}null!=t.websocket.connection?(t.websocket.connection.established=!1,t.websocket.connection.onopen=function(s){if(t.log.trace(s),t.log.info("Established connection with QZ Tray on "+r),t.websocket.setup.openConnection({resolve:o,reject:n}),e.keepAlive>0)var i=setInterval(function(){qz.websocket.isActive()?t.websocket.connection.send("ping"):clearInterval(i)},1e3*e.keepAlive)},t.websocket.connection.onclose=function(){"undefined"!=typeof navigator&&-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome")&&t.websocket.connection.onerror()},t.websocket.connection.onerror=function(e){t.log.trace(e),s()}):n(new Error("Unable to create a websocket connection"))},openConnection:function(e){function o(o){void 0===o&&(o=null),t.websocket.connection.sendData({certificate:o,promise:e})}t.websocket.connection.established=!0,t.websocket.connection.onclose=function(e){t.log.trace(e),t.log.info("Closed connection with QZ Tray"),void 0!=t.websocket.connection.promise&&t.websocket.connection.promise.resolve(),t.websocket.callClose(e),t.websocket.connection=null;for(var o in t.websocket.pendingCalls)t.websocket.pendingCalls.hasOwnProperty(o)&&t.websocket.pendingCalls[o].reject(new Error("Connection closed before response received"))},t.websocket.connection.onerror=function(e){t.websocket.callError(e)},t.websocket.connection.sendData=function(e){t.log.trace("Preparing object for websocket",e),void 0==e.timestamp&&(e.timestamp=Date.now()),void 0!=e.promise&&(e.uid=t.websocket.setup.newUID(),t.websocket.pendingCalls[e.uid]=e.promise);try{if(void 0!=e.call&&void 0==e.signature){var o={call:e.call,params:e.params,timestamp:e.timestamp},n=t.tools.hash(t.tools.stringify(o));n.then||(n=t.tools.promise(function(e){e(n)})),n.then(function(e){return t.security.callSign(e)}).then(function(o){t.log.trace("Signature for call",o),e.signature=o,t.signContent=void 0,t.websocket.connection.send(t.tools.stringify(e))})}else t.log.trace("Signature for call",e.signature),t.websocket.connection.send(t.tools.stringify(e))}catch(o){t.log.error(o),void 0!=e.promise&&(e.promise.reject(o),delete t.websocket.pendingCalls[e.uid])}},t.websocket.connection.onmessage=function(e){var o=JSON.parse(e.data);if(null!=o.uid){t.log.trace("Received response from websocket",o);var n=t.websocket.pendingCalls[o.uid];void 0==n?t.log.warn("No promise found for returned response"):void 0!=o.error?n.reject(new Error(o.error)):n.resolve(o.result),delete t.websocket.pendingCalls[o.uid]}else if(null==o.type)t.websocket.connection.close(4003,"Connected to incompatible QZ Tray version");else switch(o.type){case t.streams.serial:o.event||(o.event=JSON.stringify({portName:o.key,output:o.data})),t.serial.callSerial(JSON.parse(o.event));break;case t.streams.usb:o.event||(o.event=JSON.stringify({vendorId:o.key[0],productId:o.key[1],output:o.data})),t.usb.callUsb(JSON.parse(o.event));break;case t.streams.hid:t.hid.callHid(JSON.parse(o.event));break;default:t.log.warn("Cannot determine stream type for callback",o)}},t.security.callCert().then(o).catch(o)},newUID:function(){return(new Array(7).join("0")+(Math.random()*Math.pow(36,6)<<0).toString(36)).slice(-6)}},dataPromise:function(e,o,n,r){return t.tools.promise(function(s,i){var c={call:e,promise:{resolve:s,reject:i},params:o,signature:n,timestamp:r};t.websocket.connection.sendData(c)})},pendingCalls:{},errorCallbacks:[],callError:function(e){if(Array.isArray(t.websocket.errorCallbacks))for(var o=0;o<t.websocket.errorCallbacks.length;o++)t.websocket.errorCallbacks[o](e);else t.websocket.errorCallbacks(e)},closedCallbacks:[],callClose:function(e){if(Array.isArray(t.websocket.closedCallbacks))for(var o=0;o<t.websocket.closedCallbacks.length;o++)t.websocket.closedCallbacks[o](e);else t.websocket.closedCallbacks(e)}},printing:{defaultConfig:{colorType:"color",copies:1,density:0,duplex:!1,fallbackDensity:null,interpolation:"bicubic",jobName:null,margins:0,orientation:null,paperThickness:null,printerTray:null,rasterize:!0,rotation:0,scaleContent:!0,size:null,units:"in",altPrinting:!1,encoding:null,endOfDoc:null,perSpool:1}},serial:{serialCallbacks:[],callSerial:function(e){if(Array.isArray(t.serial.serialCallbacks))for(var o=0;o<t.serial.serialCallbacks.length;o++)t.serial.serialCallbacks[o](e);else t.serial.serialCallbacks(e)}},usb:{usbCallbacks:[],callUsb:function(e){if(Array.isArray(t.usb.usbCallbacks))for(var o=0;o<t.usb.usbCallbacks.length;o++)t.usb.usbCallbacks[o](e);else t.usb.usbCallbacks(e)}},hid:{hidCallbacks:[],callHid:function(e){if(Array.isArray(t.hid.hidCallbacks))for(var o=0;o<t.hid.hidCallbacks.length;o++)t.hid.hidCallbacks[o](e);else t.hid.hidCallbacks(e)}},security:{certPromise:function(e,t){t()},callCert:function(){return t.tools.promise(t.security.certPromise)},signaturePromise:function(){return function(e){e()}},callSign:function(e){return t.tools.promise(t.security.signaturePromise(e))}},tools:{promise:function(e){return new RSVP.Promise(e)},stringify:function(e){var t=Array.prototype.toJSON;delete Array.prototype.toJSON;var o=JSON.stringify(e);return t&&(Array.prototype.toJSON=t),o},hash:function(e){return Sha256.hash(e)},ws:"undefined"!=typeof WebSocket?WebSocket:null,absolute:function(e){if("undefined"!=typeof window&&"function"==typeof document.createElement){var t=document.createElement("a");return t.href=e,t.href}return e},extend:function(e){"object"!=typeof e&&(e={});for(var o=1;o<arguments.length;o++){var n=arguments[o];if(n)for(var r in n)if(n.hasOwnProperty(r)){if(e===n[r])continue;if(n[r]&&n[r].constructor&&n[r].constructor===Object){var s;s=Array.isArray(n[r])?e[r]||[]:e[r]||{},e[r]=t.tools.extend(s,n[r])}else void 0!==n[r]&&(e[r]=n[r])}}return e}}};return e.prototype.print=function(e,t,o){qz.print(this,e,t,o)},{websocket:{isActive:function(){return null!=t.websocket.connection&&t.websocket.connection.established},connect:function(e){return t.tools.promise(function(o,n){if(qz.websocket.isActive())n(new Error("An open connection with QZ Tray already exists"));else if(null==t.websocket.connection)if(t.tools.ws)if(t.tools.ws.CLOSED&&2!=t.tools.ws.CLOSED){void 0==e&&(e={}),"undefined"!=typeof location&&"https:"===location.protocol||void 0===e.usingSecure&&(t.log.trace("Disabling secure ports due to insecure page"),e.usingSecure=!1),void 0===e.host||Array.isArray(e.host)||(e.host=[e.host]);var r=function(s){var i=function(){e&&s<e.retries?r(s+1):(t.websocket.connection=null,n.apply(null,arguments))},c=function(){var n=t.tools.extend({},t.websocket.connectConfig,e);t.websocket.setup.findConnection(n,o,i)};0==s?c():setTimeout(c,1e3*e.delay)};r(0)}else n(new Error("Unsupported WebSocket version detected: HyBi-00/Hixie-76"));else n(new Error("WebSocket not supported by this browser"));else n(new Error("The current connection attempt has not returned yet"))})},disconnect:function(){return t.tools.promise(function(e,o){qz.websocket.isActive()?(t.websocket.connection.close(),t.websocket.connection.promise={resolve:e,reject:o}):o(new Error("No open connection with QZ Tray"))})},setErrorCallbacks:function(e){t.websocket.errorCallbacks=e},setClosedCallbacks:function(e){t.websocket.closedCallbacks=e},getNetworkInfo:function(e,o){return t.websocket.dataPromise("websocket.getNetworkInfo",{hostname:e,port:o})},getConnectionInfo:function(){if(t.websocket.connection){var e=t.websocket.connection.url.split(/[:\/]+/g);return{socket:e[0],host:e[1],port:+e[2]}}throw new Error("A connection to QZ has not been established yet")}},printers:{getDefault:function(){return t.websocket.dataPromise("printers.getDefault")},find:function(e){return t.websocket.dataPromise("printers.find",{query:e})}},configs:{setDefaults:function(e){t.tools.extend(t.printing.defaultConfig,e)},create:function(o,n){return new e(o,t.tools.extend({},t.printing.defaultConfig,n))}},print:function(e,o,n,r){for(var s=0;s<o.length;s++)o[s].constructor===Object&&(!o[s].format&&o[s].type&&"RAW"!==o[s].type.toUpperCase()||o[s].format&&("FILE"===o[s].format.toUpperCase()||"IMAGE"===o[s].format.toUpperCase()&&(0!==o[s].data.indexOf("data:image/")||0===o[s].data.indexOf(";base64,"))||"XML"===o[s].format.toUpperCase()))&&(o[s].data=t.tools.absolute(o[s].data));var i={printer:e.getPrinter(),options:e.getOptions(),data:o};return t.websocket.dataPromise("print",i,n,r)},serial:{findPorts:function(){return t.websocket.dataPromise("serial.findPorts")},setSerialCallbacks:function(e){t.serial.serialCallbacks=e},openPort:function(e,o){var n={port:e,bounds:o};return t.websocket.dataPromise("serial.openPort",n)},sendData:function(e,o,n){var r={port:e,data:o,properties:n};return t.websocket.dataPromise("serial.sendData",r)},closePort:function(e){return t.websocket.dataPromise("serial.closePort",{port:e})}},usb:{listDevices:function(e){return t.websocket.dataPromise("usb.listDevices",{includeHubs:e})},listInterfaces:function(e,o){var n={vendorId:e,productId:o};return t.websocket.dataPromise("usb.listInterfaces",n)},listEndpoints:function(e,o,n){var r={vendorId:e,productId:o,interface:n};return t.websocket.dataPromise("usb.listEndpoints",r)},setUsbCallbacks:function(e){t.usb.usbCallbacks=e},claimDevice:function(e,o,n){var r={vendorId:e,productId:o,interface:n};return t.websocket.dataPromise("usb.claimDevice",r)},isClaimed:function(e,o){var n={vendorId:e,productId:o};return t.websocket.dataPromise("usb.isClaimed",n)},sendData:function(e,o,n,r){var s={vendorId:e,productId:o,endpoint:n,data:r};return t.websocket.dataPromise("usb.sendData",s)},readData:function(e,o,n,r){var s={vendorId:e,productId:o,endpoint:n,responseSize:r};return t.websocket.dataPromise("usb.readData",s)},openStream:function(e,o,n,r,s){var i={vendorId:e,productId:o,endpoint:n,responseSize:r,interval:s};return t.websocket.dataPromise("usb.openStream",i)},closeStream:function(e,o,n){var r={vendorId:e,productId:o,endpoint:n};return t.websocket.dataPromise("usb.closeStream",r)},releaseDevice:function(e,o){var n={vendorId:e,productId:o};return t.websocket.dataPromise("usb.releaseDevice",n)}},hid:{listDevices:function(){return t.websocket.dataPromise("hid.listDevices")},startListening:function(){return t.websocket.dataPromise("hid.startListening")},stopListening:function(){return t.websocket.dataPromise("hid.stopListening")},setHidCallbacks:function(e){t.hid.hidCallbacks=e},claimDevice:function(e,o){var n={vendorId:e,productId:o};return t.websocket.dataPromise("hid.claimDevice",n)},isClaimed:function(e,o){var n={vendorId:e,productId:o};return t.websocket.dataPromise("hid.isClaimed",n)},sendData:function(e,o,n,r){var s={vendorId:e,productId:o,endpoint:r,data:n};return t.websocket.dataPromise("hid.sendData",s)},readData:function(e,o,n){var r={vendorId:e,productId:o,responseSize:n};return t.websocket.dataPromise("hid.readData",r)},openStream:function(e,o,n,r){var s={vendorId:e,productId:o,responseSize:n,interval:r};return t.websocket.dataPromise("hid.openStream",s)},closeStream:function(e,o){var n={vendorId:e,productId:o};return t.websocket.dataPromise("hid.closeStream",n)},releaseDevice:function(e,o){var n={vendorId:e,productId:o};return t.websocket.dataPromise("hid.releaseDevice",n)}},security:{setCertificatePromise:function(e){t.security.certPromise=e},setSignaturePromise:function(e){t.security.signaturePromise=e}},api:{showDebug:function(e){t.DEBUG=e},getVersion:function(){return t.websocket.dataPromise("getVersion")},setPromiseType:function(e){t.tools.promise=e},setSha256Type:function(e){t.tools.hash=e},setWebSocketType:function(e){t.tools.ws=e}},version:t.VERSION}}();!function(){if("function"==typeof define&&define.amd)define(qz);else if("object"==typeof exports){module.exports=qz;try{var e=require("crypto");qz.api.setSha256Type(function(t){return e.createHash("sha256").update(t).digest("hex")})}catch(e){}}else window.qz=qz}();